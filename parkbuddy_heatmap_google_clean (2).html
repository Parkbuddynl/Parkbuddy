
<!DOCTYPE html>
<html>
<head>
  <title>ParkBuddy Heatmap</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; }
    #meldingBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28ff98;
      color: black;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0px 2px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<div id="map"></div>
<button id="meldingBtn">Melding Doen</button>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAfOkNSl8Wg167g_RiADgW8mmGY78oMHs&libraries=visualization"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBnkd-1tvBDPC4UysDzyGC6BJ-lQj2bWYY",
    authDomain: "parkbuddy-ab716.firebaseapp.com",
    projectId: "parkbuddy-ab716",
    databaseURL: "https://parkbuddy-ab716-default-rtdb.europe-west1.firebasedatabase.app",
    storageBucket: "parkbuddy-ab716.appspot.com",
    messagingSenderId: "757948191602",
    appId: "1:757948191602:web:fe103191635916841343eb"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let map, heatmap, marker, currentLocation;

  function initMap() {
    navigator.geolocation.getCurrentPosition(pos => {
      currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: currentLocation,
        mapTypeId: "roadmap"
      });

      marker = new google.maps.Marker({
        position: currentLocation,
        map,
        draggable: true,
        title: "Verplaats voor exacte locatie",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: "#32e9fa",
          fillOpacity: 1,
          strokeWeight: 1,
          strokeColor: "#ffffff"
        }
      });

      loadHeatmap();
    });
  }

  function loadHeatmap() {
    db.ref("meldingen").on("value", snapshot => {
      const points = [];
      snapshot.forEach(child => {
        const m = child.val();
        if (Date.now() - m.timestamp < 90 * 60000) {
          points.push(new google.maps.LatLng(m.lat, m.lng));

          const confirmCount = m.confirmations || 0;
          const marker = new google.maps.Marker({
            position: { lat: m.lat, lng: m.lng },
            map: map,
            icon: {
              url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
            }
          });

          const confirmBtn = document.createElement("button");
          confirmBtn.textContent = `👍 (${confirmCount})`;
          confirmBtn.style.position = "absolute";
          confirmBtn.style.background = "#fff";
          confirmBtn.style.border = "1px solid #ccc";
          confirmBtn.style.padding = "4px 8px";
          confirmBtn.style.cursor = "pointer";

          marker.addListener("click", () => {
            if (confirm("Bevestig je deze melding?")) {
              const ref = db.ref("meldingen/" + child.key + "/confirmations");
              ref.set(confirmCount + 1);
            }
          });
        }
      });

      if (heatmap) heatmap.setMap(null);
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: points,
        map: map,
        radius: 30
      });
    });
  }

  document.getElementById("meldingBtn").addEventListener("click", () => {
    const pos = marker.getPosition();
    db.ref("meldingen").push({
      lat: pos.lat(),
      lng: pos.lng(),
      timestamp: Date.now(),
      confirmations: 0
    }).then(() => {
      alert("Melding opgeslagen!");
    });
  });

  window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAfOkNSl8Wg167g_RiADgW8mmGY78oMHs&callback=initMap&libraries=visualization"></script>
</body>
</html>
